<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Coupled Viscoelasticity and Single Phase Flow · AdFem</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="AdFem logo"/></a><div class="docs-package-name"><span class="docs-autofit">AdFem</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">AdFem.jl Documentation</a></li><li><span class="tocitem">Tutorial</span><ul><li><a class="tocitem" href="../gallery/">PDE Galleries</a></li></ul></li><li><span class="tocitem">Forward Computation</span><ul><li><a class="tocitem" href="../coupled/">Coupled Geomechanics and Single Phase Flow</a></li><li><a class="tocitem" href="../staticelasticity/">Static Linear Elasticity</a></li><li><a class="tocitem" href="../plasticity/">Plasticity</a></li><li><a class="tocitem" href="../viscoelasticity/">Viscoelasticity</a></li><li><a class="tocitem" href="../viscoelasticity_earth/">Modeling Viscoelasticity of the Earth</a></li><li><a class="tocitem" href="../earthquake/">Earthquake Simulation with Rate-and-State Friction</a></li><li><a class="tocitem" href="../heatequation/">Heat Equation</a></li><li><a class="tocitem" href="../elastodynamics/">Elastodynamics</a></li><li><a class="tocitem" href="../twophaseflow/">Coupled Geomechanics and Multiphase Flow</a></li><li><a class="tocitem" href="../NavierStokes2/">Navier-Stokes equations</a></li><li><a class="tocitem" href="../SteadyStateNavierStokes/">Steady-state Navier-Stokes equations</a></li><li><a class="tocitem" href="../SteadyStateNavierStokes3D/">Steady-state Navier-Stokes equations in 3D space</a></li><li><a class="tocitem" href="../CHTCoupled/">Conjugate heat transfer coupled solver for incompressible fluid</a></li><li><a class="tocitem" href="../fwd_mixed_poisson/">Mixed Finite Element Methods for Poisson&#39;s Equation</a></li><li><a class="tocitem" href="../fwd_linear_elasticity/">Mixed Finite Element Methods for Linear Elasticity</a></li><li><a class="tocitem" href="../fwd_stress_based_viscoelasticity/">Mixed Finite Element Methods for Linear Viscoelasticity</a></li><li><a class="tocitem" href="../pml/">Perfectly Matched Layer</a></li></ul></li><li><span class="tocitem">Inverse Modeling</span><ul><li><a class="tocitem" href="../inverse/">Inverse Modeling for Poroelasticity Models</a></li><li><a class="tocitem" href="../inv_viscoelasticity/">Inverse Modeling for Space Varying Viscoelasticity</a></li><li class="is-active"><a class="tocitem" href>Coupled Viscoelasticity and Single Phase Flow</a><ul class="internal"><li><a class="tocitem" href="#Forward-Simulation"><span>Forward Simulation</span></a></li><li><a class="tocitem" href="#Inverse-Modeling"><span>Inverse Modeling</span></a></li><li><a class="tocitem" href="#Forward-Simulation-Codes"><span>Forward Simulation Codes</span></a></li></ul></li><li><a class="tocitem" href="../inv_twophaseflow/">Coupled Geomechanics and Multiphase Flow</a></li><li><a class="tocitem" href="../inv_viscoelasticity_nonparametric/">Inverse Modeling for Nonparametric Viscoelasticity</a></li><li><a class="tocitem" href="../inv_viscoelasticity_earth/">Viscoelasticity Model for the Earth</a></li></ul></li><li><span class="tocitem">Advanced Topics</span><ul><li><a class="tocitem" href="../mfem_tutorial/">Unstructured Meshes in AdFem</a></li><li><a class="tocitem" href="../mfem_mesh/">Construct Unstructured Meshes for AdFem</a></li><li><a class="tocitem" href="../dev_unstructured/">Adding Custom Operators for Unstructured Meshes</a></li><li><a class="tocitem" href="../BDMElement/">BDM Finite Element</a></li><li><a class="tocitem" href="../mfem3d/">Working with 3D Domains</a></li></ul></li><li><a class="tocitem" href="../api/">API</a></li><li><a class="tocitem" href="../docker_install_guide/">Install &amp; Reproduce AdFem With Docker Guide</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Inverse Modeling</a></li><li class="is-active"><a href>Coupled Viscoelasticity and Single Phase Flow</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Coupled Viscoelasticity and Single Phase Flow</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/kailaix/AdFem.jl/blob/master/docs/src/coupled_viscoelasticity.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Coupled-Viscoelasticity-and-Single-Phase-Flow"><a class="docs-heading-anchor" href="#Coupled-Viscoelasticity-and-Single-Phase-Flow">Coupled Viscoelasticity and Single Phase Flow</a><a id="Coupled-Viscoelasticity-and-Single-Phase-Flow-1"></a><a class="docs-heading-anchor-permalink" href="#Coupled-Viscoelasticity-and-Single-Phase-Flow" title="Permalink"></a></h1><p>We have considered <a href="https://kailaix.github.io/AdFem.jl/dev/inv_viscoelasticity/">inverse modeling for viscoelasticity</a> and <a href="https://kailaix.github.io/AdFem.jl/dev/inverse/">coupled elasticity and single phase flow inversion</a>. A more complex case is when the constitutive relation is given by the <a href="https://kailaix.github.io/AdFem.jl/dev/viscoelasticity/">viscoelasticity</a> and the dynamics is governed by the coupled viscoelasticity and single phase flow equation. We consider the same governing equation as the <a href="https://kailaix.github.io/AdFem.jl/dev/coupled/">poreelasticity</a></p><p class="math-container">\[\begin{aligned}
\mathrm{div}\sigma(u) - b \nabla p &amp;= 0\\
\frac{1}{M} \frac{\partial p}{\partial t} + b\frac{\partial \varepsilon_v(u)}{\partial t} - \nabla\cdot\left(\frac{k}{B_f\mu}\nabla p\right) &amp;= f(x,t)
\end{aligned}\]</p><p>with boundary conditions</p><p class="math-container">\[\begin{aligned}
\sigma n = 0,\quad x\in \Gamma_{N}^u, \qquad u=0, \quad x\in \Gamma_D^u\\
-\frac{k}{B_f\mu}\frac{\partial p}{\partial n} = 0,\quad x\in \Gamma_{N}^p, \qquad p=g, \quad x\in \Gamma_D^p
\end{aligned}\]</p><p>and the initial condition</p><p class="math-container">\[p(x,0) = 0,\ u(x,0) =0,\ x\in \Omega\]</p><p>The only difference is that the consitutive relation is given by the <a href="https://kailaix.github.io/AdFem.jl/dev/viscoelasticity/#Numerical-Example-1">Maxwell material equation</a>, which has the following form in the discretization (for the definition of <span>$H$</span> and <span>$S$</span>, see <a href="https://kailaix.github.io/AdFem.jl/dev/viscoelasticity/#Numerical-Example-1">here</a>)</p><p class="math-container">\[\sigma^{n+1} = H \varepsilon^{n+1} + S \sigma^n  - H\varepsilon^n\]</p><p>Then the discretization for the mechanics is </p><p class="math-container">\[\int_\Omega H \varepsilon^{n+1} : \delta \varepsilon \;\mathrm{d}x- \int_\Omega b p \delta u \;\mathrm{d}x = \int_{\partial \Omega} \mathbf{t}\delta u \;\mathrm{d}s + \int_{\Omega} H\varepsilon^n : \delta\varepsilon \;\mathrm{d} x - \int_\Omega S\sigma^n : \delta \varepsilon \;\mathrm{d} x\]</p><p>For the discretization of the fluid equation, see <a href="https://kailaix.github.io/AdFem.jl/dev/coupled/">here</a>.</p><h2 id="Forward-Simulation"><a class="docs-heading-anchor" href="#Forward-Simulation">Forward Simulation</a><a id="Forward-Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Forward-Simulation" title="Permalink"></a></h2><p>To have an overview of the viscoelasticiy, we conduct the forward simulation in the injection-production model. An injection well is located on the left while a production well is located on the right. We impose the Dirichlet boundary conditions for <span>$u$</span>  and no flow boundary conditions for the pressure on four sides. We run the results with Lamé constants <span>$\lambda=2.0$</span> and <span>$\mu=0.5$</span>, and three different viscosity <span>$\eta = 10000, 1$</span>, and <span>$0.1$</span>. The case  <span>$\eta = 10000$</span> corresponds to a nearly linear elastic constitutive relation. The typical characteristics of viscoelasticity in our experiments are that they usually possess larger stresses and smaller displacements. </p><table><tr><th style="text-align: right">Description</th><th style="text-align: right"><span>$\eta=10000$</span></th><th style="text-align: right"><span>$\eta=1$</span></th><th style="text-align: right"><span>$\eta=0.1$</span></th></tr><tr><td style="text-align: right">Pressure</td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_p_visco10000.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_p_visco1.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_p_visco0.1.gif" alt/></td></tr><tr><td style="text-align: right"><span>$\sigma_{xx}$</span></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_sxx_visco10000.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_sxx_visco1.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_sxx_visco0.1.gif" alt/></td></tr><tr><td style="text-align: right"><span>$\sigma_{xy}$</span></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_syy_visco10000.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_syy_visco1.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_syy_visco0.1.gif" alt/></td></tr><tr><td style="text-align: right"><span>$\sigma_{yy}$</span></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_sxy_visco10000.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_sxy_visco1.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_sxy_visco0.1.gif" alt/></td></tr><tr><td style="text-align: right"><span>$u$</span></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_u_visco10000.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_u_visco1.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_u_visco0.1.gif" alt/></td></tr><tr><td style="text-align: right"><span>$v$</span></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_v_visco10000.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_v_visco1.0.gif" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/disp_v_visco0.1.gif" alt/></td></tr><tr><td style="text-align: right"><span>$\sigma_{xx}$</span> at the center point</td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/sigmaxx10000.0.jpeg" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/sigmaxx1.0.jpeg" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/sigmaxx0.1.jpeg" alt/></td></tr><tr><td style="text-align: right"><span>$u$</span> at the center point</td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/ux10000.0.jpeg" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/ux1.0.jpeg" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/ux0.1.jpeg" alt/></td></tr><tr><td style="text-align: right"><span>$\varepsilon_{xx}$</span> at the center point</td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/varepsilonxx10000.0.jpeg" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/varepsilonxx1.0.jpeg" alt/></td><td style="text-align: right"><img src="https://raw.githubusercontent.com/ADCMEMarket/ADCMEImages/master/AdFem/visco/varepsilonxx0.1.jpeg" alt/></td></tr></table><h2 id="Inverse-Modeling"><a class="docs-heading-anchor" href="#Inverse-Modeling">Inverse Modeling</a><a id="Inverse-Modeling-1"></a><a class="docs-heading-anchor-permalink" href="#Inverse-Modeling" title="Permalink"></a></h2><p>In the inverse modeling, the initial conditions and boundary conditions are </p><ul><li><p>Here <span>$u$</span>, <span>$\sigma$</span>, and <span>$p$</span> are all initialized to zero. </p></li><li><p>Fixed Dirichlet boundaries for <span>$u$</span> on the bottom. </p></li><li><p>Traction-free boundary conditions (free surface) for <span>$u$</span> on the other three sides</p></li><li><p>No-flow condition for <span>$p$</span> on all sides. </p></li></ul><p>We have 5 sets of training data, each corresponds to a Delta production (injection) source with the magnitude <span>$0.2i$</span>, <span>$i=1,2,3,4$</span> and 5​. We show a typical dataset below. </p><table><tr><th style="text-align: right">Pressure</th><th style="text-align: right"><span>$\sigma_{xx}$</span></th><th style="text-align: right"><span>$\sigma_{yy}$</span></th><th style="text-align: right"><span>$\sigma_{xy}$</span></th><th style="text-align: right"><span>$u$</span></th><th style="text-align: right"><span>$v$</span></th></tr><tr><td style="text-align: right"><img src="./assets/visco/disp_p_inv_visco1.0.gif" alt="disp_p_inv_visco1.0"/></td><td style="text-align: right"><img src="./assets/visco/disp_sxx_inv_visco1.0.gif" alt="disp_sxx_inv_visco1.0"/></td><td style="text-align: right"><img src="./assets/visco/disp_syy_inv_visco1.0.gif" alt="disp_syy_inv_visco1.0"/></td><td style="text-align: right"><img src="./assets/visco/disp_sxy_inv_visco1.0.gif" alt="disp_sxy_inv_visco1.0"/></td><td style="text-align: right"><img src="./assets/visco/disp_u_inv_visco1.0.gif" alt="disp_u_inv_visco1.0"/></td><td style="text-align: right"><img src="./assets/visco/disp_v_inv_visco1.0.gif" alt="disp_v_inv_visco1.0"/></td></tr></table><table><tr><th style="text-align: right">Displacement</th><th style="text-align: right"><span>$\sigma_{xx}$</span> at the center point</th><th style="text-align: right"><span>$\varepsilon_{xx}$</span>  at the center point</th><th style="text-align: right"><span>$u$</span> at the center point</th></tr><tr><td style="text-align: right"><img src="./assets/visco/disp_scattered_u.gif" alt="disp_scattered_u"/></td><td style="text-align: right"><img src="./assets/visco/inverse/sigmaxx1.0.jpeg" alt="sigmaxx1.0"/></td><td style="text-align: right"><img src="./assets/visco/inverse/varepsilonxx1.0.jpeg" alt="varepsilonxx1.0"/></td><td style="text-align: right"><img src="./assets/visco/inverse/ux1.0.jpeg" alt="ux1.0"/></td></tr></table><p>The observation data is the <span>$x$</span>-direction displacement at all time steps on the surface. We will consider several kinds of inversion. </p><ul><li><p><strong>Parametric inversion</strong>. In this case, we assume we already know the form of the consitutitve relation and we only need to estimate <span>$\mu$</span>, <span>$\lambda$</span> and <span>$\eta$</span>. <a href="https://github.com/kailaix/AdFem.jl/blob/master/research/visco_inverse/coupled_visco_param.jl">code</a></p></li><li><p><strong>Linear elasticity approximation</strong>. In this case, the constitutive relation is assumed to have the linear elasticity form <a href="https://github.com/kailaix/AdFem.jl/blob/master/research/visco_inverse/coupled_visco_simple.jl">code</a></p><p class="math-container">\[\sigma = H\varepsilon\]</p><p>Here <span>$H$</span> is an unknown SPD matrix. </p></li><li><p><strong>Direct inversion</strong>. The constitutive relation is substituted by </p><p><span>$\sigma^{n+1} = \mathcal{NN}(\sigma^n, \varepsilon^n)$</span></p><p>where <span>$\mathcal{NN}$</span> is a neural network. <a href="https://github.com/kailaix/AdFem.jl/blob/master/research/visco_inverse/coupled_visco_nn_direct.jl">code</a></p></li><li><p><strong>Implicit inversion</strong>. The constitutive relation is subsituted by </p><p><span>$\sigma^{n+1} = \mathcal{NN}(\sigma^n, \varepsilon^n) + H\varepsilon^{n+1}$</span></p><p>where <span>$\mathcal{NN}$</span> is a neural network and <span>$H$</span> is an unknown SPD matrix. The motivation of this form is to improve the conditioning of the implicit numerical scheme.  <a href="https://github.com/kailaix/AdFem.jl/blob/master/research/visco_inverse/coupled_visco_nn.jl">code</a></p></li></ul><p>To evaluate the inverse modeling result, we consider a test dataset which corresponds to the magnitude 0.5 for the Delta sources. We measure the displacement and Von Mises stress. For the first inversion, we report the values. </p><p>For the <strong>parametric inversion</strong>, we have the following result</p><table><tr><th style="text-align: right"><img src="./assets/visconn/loss.png" alt="loss"/></th><th style="text-align: right"><img src="./assets/visconn/s_param.gif" alt="s_param"/></th><th style="text-align: right"><img src="./assets/visconn/u_param.gif" alt="u_param"/></th></tr><tr><td style="text-align: right">Loss Function</td><td style="text-align: right">Von Mises Stress</td><td style="text-align: right">Displacement</td></tr></table><table><tr><th style="text-align: right">Parameter</th><th style="text-align: right">Initial Guess</th><th style="text-align: right">Estimated</th><th style="text-align: right">True</th></tr><tr><td style="text-align: right"><span>$\mu$</span></td><td style="text-align: right">1.5</td><td style="text-align: right">0.49999986292871396</td><td style="text-align: right">0.5</td></tr><tr><td style="text-align: right"><span>$\lambda$</span></td><td style="text-align: right">1.5</td><td style="text-align: right">1.9999997784851993</td><td style="text-align: right">2.0</td></tr><tr><td style="text-align: right"><span>$\eta$</span></td><td style="text-align: right">1.5</td><td style="text-align: right">0.9999969780184615</td><td style="text-align: right">1.0</td></tr></table><p>For the other three types of inversion, the results are presented below</p><table><tr><th style="text-align: right">Reference</th><th style="text-align: right">Linear Elasticity</th><th style="text-align: right">Direct</th><th style="text-align: right">Implicit</th></tr><tr><td style="text-align: right"><img src="./assets/visconn/disp_s_inv_visco_ref.gif" alt="disp_s_inv_visco_ref"/></td><td style="text-align: right"><img src="./assets/visconn/s_l.gif" alt="s_l"/></td><td style="text-align: right"><img src="./assets/visconn/s_di.gif" alt="s_di"/></td><td style="text-align: right"><img src="./assets/visconn/s_nn.gif" alt="s_nn"/></td></tr><tr><td style="text-align: right"><img src="./assets/visconn/disp_scattered_u_inv_visco_ref.gif" alt="disp_scattered_u_inv_visco_ref"/></td><td style="text-align: right"><img src="./assets/visconn/u_l.gif" alt="u_l"/></td><td style="text-align: right"><img src="./assets/visconn/u_di.gif" alt="u_di"/></td><td style="text-align: right"><img src="./assets/visconn/u_nn.gif" alt="u_nn"/></td></tr></table><p>The results are reported at 2000-th iteration. In terms of the Von Mises stress, we see that the direct training gives us the best result (note the <strong>scale of the colorbar</strong>). </p><h2 id="Forward-Simulation-Codes"><a class="docs-heading-anchor" href="#Forward-Simulation-Codes">Forward Simulation Codes</a><a id="Forward-Simulation-Codes-1"></a><a class="docs-heading-anchor-permalink" href="#Forward-Simulation-Codes" title="Permalink"></a></h2><pre><code class="language-julia">using Revise
using AdFem
using PyCall
using LinearAlgebra
using ADCME
using MAT
using PyPlot
np = pyimport(&quot;numpy&quot;)

# Domain information 
NT = 50
Δt = 1/NT
n = 20
m = 2*n 
h = 1.0/n 
bdnode = Int64[]
for i = 1:m+1
    for j = 1:n+1
        if i==1 || i==m+1 || j==1|| j==n+1
            push!(bdnode, (j-1)*(m+1)+i)
        end
    end
end

is_training = false
b = 1.0

invη = 1.0
if length(ARGS)==1
    global invη = parse(Float64, ARGS[1])
end

λ = constant(2.0)
μ = constant(0.5)
invη = constant(invη)

iS = tensor(
    [1+2/3*μ*Δt*invη -1/3*μ*Δt*invη 0.0
    -1/3*μ*Δt*invη 1+2/3*μ*Δt*invη 0.0 
    0.0 0.0 1+μ*Δt*invη]
)
S = inv(iS)
H = S * tensor([
    2μ+λ λ 0.0
    λ 2μ+λ 0.0
    0.0 0.0 μ
])


Q = SparseTensor(compute_fvm_tpfa_matrix(m, n, h))
K = compute_fem_stiffness_matrix(H, m, n, h)
L = SparseTensor(compute_interaction_matrix(m, n, h))
M = SparseTensor(compute_fvm_mass_matrix(m, n, h))
A = [K -b*L&#39;
b*L/Δt 1/Δt*M-Q]
A, Abd = fem_impose_coupled_Dirichlet_boundary_condition(A, bdnode, m, n, h)
# error()
U = zeros(m*n+2(m+1)*(n+1), NT+1)
x = Float64[]; y = Float64[]
for j = 1:n+1
    for i = 1:m+1
        push!(x, (i-1)*h)
        push!(y, (j-1)*h)
    end
end
    
injection = (div(n,2)-1)*m + 3
production = (div(n,2)-1)*m + m-3


function condition(i, tas...)
    i&lt;=NT
end

function body(i, tas...)
    ta_u, ta_ε, ta_σ = tas
    u = read(ta_u, i)
    σ0 = read(ta_σ, i)
    ε0 = read(ta_ε, i)
    rhs1 = compute_fem_viscoelasticity_strain_energy_term(ε0, σ0, S, H, m, n, h)
    rhs2 = zeros(m*n)
    rhs2[injection] += 1.0
    rhs2[production] -= 1.0
    rhs2 += b*L*u[1:2(m+1)*(n+1)]/Δt + 
            M * u[2(m+1)*(n+1)+1:end]/Δt
    rhs = [rhs1;rhs2]
    o = A\rhs 

    ε = eval_strain_on_gauss_pts(o, m, n, h)
    σ = σ0*S + (ε - ε0)*H
    ta_u = write(ta_u, i+1, o)
    ta_ε = write(ta_ε, i+1, ε)
    ta_σ = write(ta_σ, i+1, σ)
    i+1, ta_u, ta_ε, ta_σ
end

i = constant(1, dtype=Int32)
ta_u = TensorArray(NT+1); ta_u = write(ta_u, 1, constant(zeros(2(m+1)*(n+1)+m*n)))
ta_ε = TensorArray(NT+1); ta_ε = write(ta_ε, 1, constant(zeros(4*m*n, 3)))
ta_σ = TensorArray(NT+1); ta_σ = write(ta_σ, 1, constant(zeros(4*m*n, 3)))
_, u_out, ε_out, σ_out = while_loop(condition, body, [i, ta_u, ta_ε, ta_σ])
u_out = stack(u_out)
u_out.set_shape((NT+1, size(u_out,2)))
σ_out = stack(σ_out)
ε_out = stack(ε_out)

upper_idx = Int64[]
for i = 1:m+1
    push!(upper_idx, (div(n,3)-1)*(m+1)+i)
    push!(upper_idx, (div(n,3)-1)*(m+1)+i + (m+1)*(n+1))
end
for i = 1:m 
    push!(upper_idx, (div(n,3)-1)*m+i+2(m+1)*(n+1))
end

sess = Session(); init(sess)
U, Sigma, Varepsilon, ev = run(sess, [u_out,σ_out,ε_out, invη])
visualize_displacement(U&#39;|&gt;Array, m, n, h, name=&quot;_visco$ev&quot;)
visualize_pressure(U&#39;|&gt;Array, m, n, h, name=&quot;_visco$ev&quot;)
visualize_displacement(U&#39;|&gt;Array, m, n, h, name=&quot;_visco$ev&quot;)
visualize_stress(Sigma[:,:,1]&#39;|&gt;Array, m, n, h, name=&quot;xx_visco$ev&quot;)
visualize_stress(Sigma[:,:,2]&#39;|&gt;Array, m, n, h, name=&quot;yy_visco$ev&quot;)
visualize_stress(Sigma[:,:,3]&#39;|&gt;Array, m, n, h, name=&quot;xy_visco$ev&quot;)


idx = m÷2 + (n÷2)*m
close(&quot;all&quot;)
plot(LinRange(0,1.0, NT+1),Sigma[:,4*(idx-1)+1,1])
xlabel(&quot;time&quot;)
ylabel(&quot;\$\\sigma_{xx}\$&quot;)
savefig(&quot;sigmaxx$ev.jpeg&quot;)

close(&quot;all&quot;)
plot(LinRange(0,1.0, NT+1),Varepsilon[:,4*(idx-1)+1,1])
xlabel(&quot;time&quot;)
ylabel(&quot;\$\\varepsilon_{xx}\$&quot;)
savefig(&quot;varepsilonxx$ev.jpeg&quot;)

idx = m÷2 + (n÷2)*(m+1)
close(&quot;all&quot;)
plot(LinRange(0,1.0, NT+1),U[:,4*(idx-1)+1])
xlabel(&quot;time&quot;)
ylabel(&quot;\$u_x\$&quot;)
savefig(&quot;ux$ev.jpeg&quot;)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../inv_viscoelasticity/">« Inverse Modeling for Space Varying Viscoelasticity</a><a class="docs-footer-nextpage" href="../inv_twophaseflow/">Coupled Geomechanics and Multiphase Flow »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 5 June 2021 23:04">Saturday 5 June 2021</span>. Using Julia version 1.4.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
